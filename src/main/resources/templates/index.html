<!DOCTYPE html>
<html xmlns:th="http://thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Index</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
	<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
</head>
<body>
	<div class="container-fluid">
		<div class="row">
			<div class="sidebar border border-right col-md-3 col-lg-2 p-0 bg-body-tertiary">
				<div class="offcanvas-lg offcanvas-end bg-body-tertiary" tabindex="-1" id="sidebarMenu" aria-labelledby="sidebarMenuLabel">
					<div class="offcanvas-header">
						<h5 class="offcanvas-title" id="sidebarMenuLabel">Menu</h5>
						<button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
					</div>
					<div class="offcanvas-body">
						<ul class="nav flex-column">
							<li class="nav-item">
								<a class="nav-link active" aria-current="page" href="#">Home</a>
							</li>
							<li class="nav-item">
								<a class="nav-link" href="#">Features</a>
							</li>
							<li class="nav-item">
								<a class="nav-link" href="#">Pricing</a>
							</li>
						</ul>
					</div>
				</div>
			</div>
			<div class="offcanvas-body d-md-flex flex-column p-0 pt-lg-3 overflow-y-auto">
				<div class="table-responsive small">
					<table class="table table-striped">
						<thead>
							<tr>
								<th>ID</th>
								<th>Fecha</th>
								<th>Cliente</th>
								<th>Estado</th>		
								<th>&nbsp;</th>
							</tr>		
						</thead>
						<tbody>
							<tr th:each="pedido:${pedidos}">
								<td th:text="${pedido.id}"></td>
								<td th:text="${pedido.fecha}"></td>
								<td th:text="${pedido.cliente}"></td>
								<td th:text="${pedido.activo}"></td>
								<td>
									<a href="@{pedido}/${pedido.id}">ir</a>
								</td>
							</tr>
						</tbody>
					</table>
				</div>
			</div>
			<div class="header"><h2>Pedidos</h2></div>
			<form id="pedidoForm" method="post" >
				<label>Cliente:</label>
				<input type="text" name="cliente" required>
				<label>Fecha:</label>
				<input type="date" name="fecha" required>
				<div id="addFields">
					<input type="text" name="producto[]" placeholder="Producto" required>
					<input type="number" name="cantidad[]" placeholder="Cantidad" required>
					<input type="number" step="0.1" name="precio[]" placeholder="Precio" required>
				</div>
				<button class="btn btn-primary" type="button" onclick="addFields();">Agregar Producto</button>
				<input  class="btn btn-success" type="submit" value="Crear Pedido">
			</form>
		</div>
		
	</div>
	<!--  
	<form method="post" th:action="@{/pedido}">
		<label>Nombre:</label>
		<input type="text" th:field="*{nombre}">
	</form>
	-->
	<script src="https://code.jquery.com/jquery-3.7.1.slim.js" integrity="sha256-UgvvN8vBkgO0luPSUl2s8TIlOSYRoGFAX4jlCIm9Adc=" crossorigin="anonymous"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
	<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
	<script type="text/javascript">
		function addFields() {
			var field = '<input type="text" name="producto[]" placeholder="Producto" required><input type="number" name="cantidad[]" placeholder="Cantidad" required><input type="number" step="0.1" name="precio[]" placeholder="Precio" required>';
			$('#addFields').append(field);
		}
		function notifcation(message, type='success'){
			Toastify({
				text: message,
				duration: 3000,
				close: true,
				gravity: "top", // `top` or `bottom`
				position: 'right', // `left`, `center` or `right`
				backgroundColor: type=='success'?"#4fbe87":"#ff6b6b",
				stopOnFocus: true, // Prevents dismissing of toast on hover
			}).showToast();
		}
		$(document).ready(function(){
			$('#pedidoForm').on('submit', function(e){
				e.preventDefault();
				console.log("Enviando formulario");
				var pedido = {};
				var cliente = $('input[name="cliente"]').val();
				var fecha = $('input[name="fecha"]').val();
				pedido.cliente = cliente;
				pedido.fecha = fecha;
				var productos = [];
				$('input[name="producto[]"]').each(function(index, value){
					var producto = {};
					producto.producto = $(this).val();
					producto.cantidad = $('input[name="cantidad[]"]').eq(index).val();
					producto.precio = $('input[name="precio[]"]').eq(index).val();
					productos.push(producto); 
				});
				pedido.detalles = productos;
				fetch('/pedir', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					},
					body: JSON.stringify(pedido)
				}).then(response => response.json()).then(data => {
					if(data.success){	
						$('#pedidoForm')[0].reset();
						notifcation(data.mensaje, 'success');
						setTimeout(function(){
							location.reload();
						}, 3000);
					}
				});
			});	
		});
		var estatus = navigator.onLine;
		console.log("Estado conexion: "+estatus);
		
	</script>
</body>
</html>